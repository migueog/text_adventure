# Database Module

This directory contains the Drizzle ORM database configuration and schema for the Text Adventure Campaign Manager.

## Files

- **`schema.ts`** - Database table definitions and TypeScript types
- **`client.ts`** - Drizzle database client configuration
- **`queries.example.ts`** - Example queries demonstrating type-safe database operations
- **`migrations/`** - SQL migration files generated by Drizzle Kit

## Quick Start

### 1. Set Up Database

**Choose a hosting provider** (see [DATABASE_SETUP.md](../../DATABASE_SETUP.md)):
- **Neon** (recommended): Free 10 GB, serverless-optimized
- **Supabase**: Free 500 MB, includes auth/storage
- **Local PostgreSQL**: For offline development

**Configure connection:**
```bash
cp .env.example .env
# Edit .env and add your DATABASE_URL
```

### 2. Test Connection

Verify your database is accessible:
```bash
npm run db:test
```

### 3. Run Migrations

Apply the database schema:
```bash
npm run db:migrate
```

### 4. Verify Setup

Ensure everything is configured correctly:
```bash
npm run db:verify
```

### 5. Use in Your Application

Import and use the database client:

```typescript
import { db } from './lib/db/client'
import { users, campaigns } from './lib/db/schema'

// Query users
const allUsers = await db.select().from(users)

// Insert a campaign
const newCampaign = await db.insert(campaigns).values({
  name: 'My Campaign',
  ownerId: 1,
  settings: { /* ... */ },
  gameState: { /* ... */ },
  status: 'setup'
}).returning()
```

## Available Scripts

- `npm run db:generate` - Generate migration files from schema changes
- `npm run db:migrate` - Apply pending migrations to database
- `npm run db:push` - Apply schema directly to database (prototyping only)
- `npm run db:studio` - Open Drizzle Studio (visual database browser)
- `npm run db:drop` - Drop the last migration
- `npm run db:test` - Test database connection
- `npm run db:verify` - Verify complete database setup

### Script Usage

**For Initial Setup:**
```bash
npm run db:test      # 1. Verify connection
npm run db:migrate   # 2. Apply schema
npm run db:verify    # 3. Verify everything
```

**For Schema Changes:**
```bash
npm run db:generate  # 1. Generate migration
npm run db:migrate   # 2. Apply migration
npm run db:studio    # 3. Verify changes
```

**For Troubleshooting:**
```bash
npm run db:test      # Test connection
npm run db:verify    # Full verification
VERBOSE=true npm run db:test  # Detailed connection info
```

## Schema Overview

### Tables

1. **users** - User accounts
2. **campaigns** - Game campaigns with settings and state
3. **campaign_players** - Players participating in campaigns
4. **invitations** - Pending campaign invitations

### Relationships

- A user can own multiple campaigns
- A campaign has one owner (user)
- A campaign can have multiple players
- A player belongs to one campaign and one user
- A campaign can have multiple invitations

## Type Safety

All database operations are fully type-safe. Import types from the schema:

```typescript
import type { User, Campaign, CampaignPlayer } from './lib/db/schema'
```

## Documentation

See [DATABASE_SCHEMA.md](../../DATABASE_SCHEMA.md) for complete schema documentation including:
- Detailed table structures
- JSONB field schemas
- Usage examples
- Query patterns
- Security considerations

## Example Queries

See `queries.example.ts` for comprehensive examples of:
- Creating and querying users
- Managing campaigns
- Adding players to campaigns
- Handling invitations
- Complex joins and filters
